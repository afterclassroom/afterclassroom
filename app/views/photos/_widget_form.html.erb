<div class="photoEx">asdfasfasfsadfsdf
  <div class="stoExItem">
    <div class="stoExItemL">
      Photo album name:
    </div>
    <div class="stoExItemR">
      <%= @photo_album.name %>
    </div>
  </div>
  <div class="files">
    <%= form_for :photo, :url => upload_user_photos_url(current_user), :html => { :class => "upload", :multipart => true, :id => "photo_form" } do |f| %>
      <%= hidden_field_tag "photo[photo_album_id]", @photo_album.id %>
      <%= file_field_tag "photo[photo_attach]", :multiple => true %>
      <div>
        Select photos
      </div>
    <% end %>
    <table class="upload_files" width="100%">
    </table>
    <div class="stoExBtm">
      <div class="stoExSave" id="start_uploads">
        <a onclick="$('#story_state').val('draft');$('#form_new').submit();" href="javascript:;">Start Uploads</a>
      </div>
      <div class="stoExSave"><%= link_to "View Photos", show_album_user_photos_path(@photo_album.user, :photo_album_id => @photo_album) %></div>
      <div class="stoExCan"><a href="javascript:;" onclick="$('#create_a_album').hide();">Cancel</a></div>
    </div>
    <br/>
    <table class="download_files" width="100%">
    </table>
  </div>
</div>

<!--Alert-->
<div id="delete-dialog-message" title="Confirm delete" style="display:none;">
  <p>
    Really delete the highlighted element?
  </p>
</div>
<!--Alert-->

<script type="text/javascript" charset="utf-8">
  $(function(){
    $('#photo_form').each(function(){
      // Fix for browsers which support multiple file selection but not the File API:
      // https://github.com/blueimp/jQuery-File-Upload/issues#issue/36
      if (typeof File === 'undefined') {
        $(this).find('input:file').each(function(){
          // Fix for Opera, which ignores just removing the multiple attribute:
          
        });
      }
    }).fileUploadUI({
      uploadTable: $('.upload_files'),
      downloadTable: $('.download_files'),
      buildUploadRow: function(files, index){
        var fileNames;
        if (typeof index == 'number') {
          fileNames = files[index].name;
        }
        else {
          fileNames = '';
          for (i = 0; i < files.length; i += 1) {
            fileNames = fileNames + files[i].name + '<br>';
          }
        }
        return $('<tr><td class="file_upload_preview"><\/td>' +
          '<td class="file_upload_title">' +
          '<span>'+
          fileNames + 
          '<\/span>' +
          '<div class="file_upload_title_photo">.....<\/div>' +
          '<\/td>' +
          '<td class="file_upload_txt_title"><input type="text" title="Title" class="musicTitle" value="Title"><\/td>' +
          '<td class="file_upload_progress"><div><\/div><\/td>' +
          '<td class="file_upload_start">' +
          '<button class="ui-state-default ui-corner-all" title="Start Upload">' +
          '<span class="ui-icon ui-icon-circle-arrow-e">Start Upload<\/span>' +
          '<\/button><\/td>' +
          '<td class="file_upload_cancel">' +
          '<button class="ui-state-default ui-corner-all" title="Cancel">' +
          '<span class="ui-icon ui-icon-cancel">Cancel<\/span>' +
          '<\/button><\/td><\/tr>');
      },
      buildDownloadRow: function(file){
        return $('<tr id="file_' + file.id + '"><td><div class="photoImg"><a href="javascript:;"><div><img src="' + file.pic_path + '"></div></a></div>' + file.name + '<\/td>' +
          '<td class="file_delete"><button title="Delete" class="ui-state-default ui-corner-all"><span class="ui-icon ui-icon-trash"></span></button></td>' +
          '<\/tr>');
      },
      beforeSend: function(event, files, index, xhr, handler, callBack){
        var regexp = /\.(png)|(jpg)|(gif)$/i;
        // Using the filename extension for our test,
        // as legacy browsers don't report the mime type
        if (!regexp.test(files[index].name)) {
          handler.uploadRow.find('.file_upload_progress').html('ONLY IMAGES ALLOWED!');
          setTimeout(function(){
            handler.removeNode(handler.uploadRow);
          }, 10000);
          return;
        }
                    
        if (files[index].size > 10000000) {
          handler.uploadRow.find('.file_upload_progress').html('FILE TOO BIG!');
          setTimeout(function(){
            handler.removeNode(handler.uploadRow);
          }, 10000);
          return;
        }
                    
        handler.uploadRow.find('.file_upload_start button').click(function(){
          title = handler.uploadRow.find('.file_upload_txt_title input').val();
          if (title == "Title"){
            title = "";
          }
          handler.formData = {
            "photo[title]": title,
            "photo[photo_album_id]": $('#photo_photo_album_id').val(),
            "authenticity_token": $('[name="authenticity_token"]').val()
          };
          callBack();
        });
      }
    });
    $('.musicTitle').each(function() {
      var default_value = this.value;
      $(this).focus(function() {
        if(this.value == default_value) {
          this.value = '';
        }
      });
      $(this).blur(function() {
        if(this.value == '') {
          this.value = default_value;
        }
      });
    });
  });
        
  $('#start_uploads').click(function(){
    $('.file_upload_start button').click();
  });
    	
  $('#cancel_uploads').click(function(){
    $('.file_upload_cancel button').click();
  });
		
  $('.file_delete button').live('click', function () {
    deleteFile(getKey($(this).closest('tr')));
    return false;
  });
			
  function deleteItem(node, url, callBack) {
    node.addClass('ui-state-highlight');
    $("#delete-dialog-message").dialog({
      modal: true,
      buttons: {
        Delete: function() {
          $.ajax({
            url: url,
            type: 'DELETE',
            success: function (data) {
              callBack(data);
            }
          });
        },
        Cancel: function() {
          $("#delete-dialog-message").dialog('close');
          node.removeClass('ui-state-highlight');
        }
      }
    });
  }

  function deleteFile(key) {
    var path = "<%= user_photos_url(current_user)%>/" + key;
    var node = getFileNode(key);
    deleteItem(node, path, function (data) {
      node.fadeOut(function () {
        $("#delete-dialog-message").dialog('close');
        $(this).remove();
      });
    });
  }
		
  function getKey(node) {
    return node.attr('id').replace(/\w+?_/, '');
  }
			
  function getFileNode(key) {
    return $('#file_' + key);
  }

  $('.file_upload_title span').each(function(){
    var $this = $(this);
    if($this.width() > $this.parent().width()){
      $this.parent().find('.file_upload_title_photo').show();
    }
  });

</script>
